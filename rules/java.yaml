# ==========================================
# Java Threat Detection Rules
# ==========================================

rules:
  # Regula 1: Detect Runtime.exec and ProcessBuilder usage (Medium-High risk) -> Mark 30 points
  - id: java-runtime-exec
    pattern-either:
      - pattern: Runtime.getRuntime().exec(...)
      - pattern: new ProcessBuilder(...)
      - pattern: new ProcessBuilder(...).start()
    message: "[Java] Critical: Process execution detected."
    languages: [java]
    severity: ERROR
    metadata:
      risk_score: 30
      category: rce

  # Regula 2: Detect command injection via concatenation (High risk) -> Mark 75 points
  - id: java-command-injection
    patterns:
      - pattern-either:
          - pattern: Runtime.getRuntime().exec($CMD + ...)
          - pattern: Runtime.getRuntime().exec("..." + $VAR + ...)
          - pattern: new ProcessBuilder($CMD + ...)
    message: "[Java] High: Command injection via string concatenation detected."
    languages: [java]
    severity: ERROR
    metadata:
      risk_score: 75
      category: rce

  # Regula 3: Detect reverse shell patterns (Critical) -> Mark 100 points
  - id: java-reverse-shell-stream
    patterns:
      - pattern: |
          Process $P = ...;
          ...
          $P.getInputStream()
          ...
          $P.getOutputStream()
    message: "[Java] Critical: Potential Reverse Shell (Process I/O redirection)."
    languages: [java]
    severity: ERROR
    metadata:
      risk_score: 100
      category: backdoor

  # Regula 4: Detect unsafe deserialization (Critical) -> Mark 95 points
  - id: java-unsafe-deserialization
    pattern-either:
      - pattern: new ObjectInputStream(...).readObject()
      - pattern: $OIS.readObject()
    message: "[Java] Critical: Unsafe deserialization - potential RCE (e.g., Commons Collections exploit)."
    languages: [java]
    severity: ERROR
    metadata:
      risk_score: 95
      category: deserialization

  # Regula 5: Detect JNDI injection (Critical) -> Mark 100 points
  - id: java-jndi-injection
    pattern-either:
      - pattern: $CTX.lookup(...)
      - pattern: new InitialContext().lookup(...)
    message: "[Java] Critical: JNDI lookup detected - potential Log4Shell-like attack vector."
    languages: [java]
    severity: ERROR
    metadata:
      risk_score: 100
      category: code_injection

  # Regula 6: Detect dangerous reflection usage (High risk) -> Mark 40 points
  - id: java-reflection-loading
    pattern-either:
      - pattern: Class.forName($VAR)
      - pattern: $CL.loadClass($VAR)
      - pattern: $METHOD.invoke(...)
      - pattern: $CONSTRUCTOR.newInstance(...)
      - patterns:
          - pattern: Method.invoke($OBJ, ...)
          - pattern-inside: |
              Method $METHOD = ...
              ...
    message: "[Java] High: Dynamic class/method loading (Reflection) - check for hidden payloads."
    languages: [java]
    severity: WARNING
    metadata:
      risk_score: 40
      category: code_injection

  # Regula 7: Detect JNI library loading (High risk) -> Mark 40 points
  - id: java-jni-loading
    pattern-either:
      - pattern: System.loadLibrary($LIB)
      - pattern: System.load($PATH)
      - pattern: Runtime.getRuntime().load($PATH)
    message: "[Java] High: Native library loading (JNI) - may load malicious DLL/SO."
    languages: [java]
    severity: WARNING
    metadata:
      risk_score: 40
      category: code_injection



  # Regula 10: Detect script engine execution (High risk) -> Mark 85 points
  - id: java-script-engine
    pattern-either:
      - pattern: new ScriptEngineManager().getEngineByName(...)
      - pattern: $ENGINE.eval($SCRIPT)
      - patterns:
          - pattern: $ENGINE.eval(...)
          - pattern-inside: |
              ScriptEngine $ENGINE = ...
              ...
    message: "[Java] High: Script engine execution - potential arbitrary code execution."
    languages: [java]
    severity: ERROR
    metadata:
      risk_score: 85
      category: code_injection



  # Regula 12: Detect network connections (Low-Medium risk) -> Mark 30 points
  - id: java-network-connection
    pattern-either:
      - pattern: new URL($URL)
      - pattern: new Socket($HOST, $PORT)
      - pattern: $URL.openConnection()
      - pattern: HttpURLConnection ...
    message: "[Java] Info: Outbound network connection detected."
    languages: [java]
    severity: INFO
    metadata:
      risk_score: 30
      category: network



  # Regula 15: Detect Spring Expression Language injection (Critical) -> Mark 90 points
  - id: java-spel-injection
    patterns:
      - pattern-either:
          - pattern: $PARSER.parseExpression($EXPR)
          - pattern: new SpelExpressionParser().parseExpression(...)
          - patterns:
              - pattern: SpelExpressionParser.parseExpression($VAR)
              - pattern-not: SpelExpressionParser.parseExpression("...")
    message: "[Java] Critical: SpEL injection - potential RCE via expression language."
    languages: [java]
    severity: ERROR
    metadata:
      risk_score: 90
      category: code_injection