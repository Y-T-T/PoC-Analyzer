# ==========================================
# Java Threat Detection Rules
# ==========================================

rules:
  # Regula 1: Detect Runtime.exec and ProcessBuilder usage (Medium-High risk) -> Mark 30 points
  - id: java-runtime-exec
    pattern-either:
      - pattern: Runtime.getRuntime().exec(...)
      - pattern: new ProcessBuilder(...)
      - pattern: new ProcessBuilder(...).start()
    message: "[Java] Critical: Process execution detected."
    languages: [java]
    severity: ERROR
    metadata:
      risk_score: 30
      category: rce

  # Regula 2: Detect command injection via concatenation (High risk) -> Mark 75 points
  - id: java-command-injection
    patterns:
      - pattern-either:
          - pattern: Runtime.getRuntime().exec($CMD + ...)
          - pattern: Runtime.getRuntime().exec("..." + $VAR + ...)
          - pattern: new ProcessBuilder($CMD + ...)
    message: "[Java] High: Command injection via string concatenation detected."
    languages: [java]
    severity: ERROR
    metadata:
      risk_score: 75
      category: rce

  # Regula 3: Detect reverse shell patterns (Critical) -> Mark 100 points
  - id: java-reverse-shell-stream
    patterns:
      - pattern: |
          Process $P = ...;
          ...
          $P.getInputStream()
          ...
          $P.getOutputStream()
    message: "[Java] Critical: Potential Reverse Shell (Process I/O redirection)."
    languages: [java]
    severity: ERROR
    metadata:
      risk_score: 100
      category: backdoor

  # Regula 4: Detect unsafe deserialization (Critical) -> Mark 95 points
  - id: java-unsafe-deserialization
    pattern-either:
      - pattern: new ObjectInputStream(...).readObject()
      - pattern: $OIS.readObject()
    message: "[Java] Critical: Unsafe deserialization - potential RCE (e.g., Commons Collections exploit)."
    languages: [java]
    severity: ERROR
    metadata:
      risk_score: 95
      category: deserialization

  # Regula 5: Detect JNDI injection (Critical) -> Mark 100 points
  - id: java-jndi-injection
    pattern-either:
      - pattern: $CTX.lookup(...)
      - pattern: new InitialContext().lookup(...)
    message: "[Java] Critical: JNDI lookup detected - potential Log4Shell-like attack vector."
    languages: [java]
    severity: ERROR
    metadata:
      risk_score: 100
      category: code_injection

  # Regula 6: Detect dangerous reflection usage (High risk) -> Mark 40 points
  - id: java-reflection-loading
    pattern-either:
      - pattern: Class.forName($VAR)
      - pattern: $CL.loadClass($VAR)
      - pattern: $METHOD.invoke(...)
      - pattern: $CONSTRUCTOR.newInstance(...)
      - patterns:
          - pattern: Method.invoke($OBJ, ...)
          - pattern-inside: |
              Method $METHOD = ...
              ...
    message: "[Java] High: Dynamic class/method loading (Reflection) - check for hidden payloads."
    languages: [java]
    severity: WARNING
    metadata:
      risk_score: 40
      category: code_injection

  # Regula 7: Detect JNI library loading (High risk) -> Mark 40 points
  - id: java-jni-loading
    pattern-either:
      - pattern: System.loadLibrary($LIB)
      - pattern: System.load($PATH)
      - pattern: Runtime.getRuntime().load($PATH)
    message: "[Java] High: Native library loading (JNI) - may load malicious DLL/SO."
    languages: [java]
    severity: WARNING
    metadata:
      risk_score: 40
      category: code_injection

  # Regula 8: Detect XXE vulnerabilities (High risk) -> Mark 80 points
  - id: java-xxe-vulnerability
    patterns:
      - pattern-either:
          - patterns:
              - pattern: DocumentBuilderFactory.newInstance()
              - pattern-not-inside: |
                  $DBF.setFeature("...", true);
                  ...
          - patterns:
              - pattern: SAXParserFactory.newInstance()
              - pattern-not-inside: |
                  $SPF.setFeature("...", true);
                  ...
          - pattern: new XMLReader()
    message: "[Java] High: XML External Entity (XXE) vulnerability - parser not configured securely."
    languages: [java]
    severity: ERROR
    metadata:
      risk_score: 80
      category: xxe

  # Regula 9: Detect SQL injection (High risk) -> Mark 70 points
  - id: java-sql-injection
    patterns:
      - pattern-either:
          - pattern: $STMT.executeQuery($SQL)
          - pattern: $STMT.execute($SQL)
          - pattern: $STMT.executeUpdate($SQL)
      - pattern-either:
          - pattern-inside: |
              $SQL = "..." + $VAR + ...;
              ...
          - pattern-inside: |
              $SQL = ... + $VAR + ...;
              ...
          - pattern-inside: |
              ... $SQL = "..." + ...;
              ...
    message: "[Java] High: SQL injection - use PreparedStatement instead of string concatenation."
    languages: [java]
    severity: ERROR
    metadata:
      risk_score: 70
      category: sql_injection

  # Regula 10: Detect script engine execution (High risk) -> Mark 85 points
  - id: java-script-engine
    pattern-either:
      - pattern: new ScriptEngineManager().getEngineByName(...)
      - pattern: $ENGINE.eval($SCRIPT)
      - patterns:
          - pattern: $ENGINE.eval(...)
          - pattern-inside: |
              ScriptEngine $ENGINE = ...
              ...
    message: "[Java] High: Script engine execution - potential arbitrary code execution."
    languages: [java]
    severity: ERROR
    metadata:
      risk_score: 85
      category: code_injection

  # Regula 11: Detect file operations with user input (Medium risk) -> Mark 50 points
  - id: java-file-operations
    pattern-either:
      - pattern: new File($PATH)
      - pattern: new FileInputStream($PATH)
      - pattern: new FileOutputStream($PATH)
      - pattern: Files.write($PATH, ...)
      - pattern: Files.readAllBytes($PATH)
    message: "[Java] Warning: File operation - ensure path is validated to prevent path traversal."
    languages: [java]
    severity: WARNING
    metadata:
      risk_score: 50
      category: file_manipulation

  # Regula 12: Detect network connections (Low-Medium risk) -> Mark 30 points
  - id: java-network-connection
    pattern-either:
      - pattern: new URL($URL)
      - pattern: new Socket($HOST, $PORT)
      - pattern: $URL.openConnection()
      - pattern: HttpURLConnection ...
    message: "[Java] Info: Outbound network connection detected."
    languages: [java]
    severity: INFO
    metadata:
      risk_score: 30
      category: network

  # Regula 13: Detect hardcoded credentials (Medium risk) -> Mark 35 points
  - id: java-hardcoded-credentials
    patterns:
      - pattern-either:
          - pattern: |
              $VAR = "...";
          - pattern: |
              final $TYPE $VAR = "...";
      - metavariable-regex:
          metavariable: $VAR
          regex: ".*(password|passwd|pwd|secret|token|apikey|api_key|apiKey).*"
    message: "[Java] Warning: Potential hardcoded credentials detected."
    languages: [java]
    severity: WARNING
    metadata:
      risk_score: 35
      category: credential_leak

  # Regula 14: Detect weak cryptography (Medium risk) -> Mark 45 points
  - id: java-weak-crypto
    pattern-either:
      - pattern: MessageDigest.getInstance("MD5")
      - pattern: MessageDigest.getInstance("SHA1")
      - pattern: MessageDigest.getInstance("SHA-1")
      - pattern: Cipher.getInstance("DES")
      - pattern: Cipher.getInstance("DES/...")
      - pattern: SecureRandom.getInstance("SHA1PRNG")
    message: "[Java] Warning: Weak cryptographic algorithm usage."
    languages: [java]
    severity: WARNING
    metadata:
      risk_score: 45
      category: weak_crypto

  # Regula 15: Detect Spring Expression Language injection (Critical) -> Mark 90 points
  - id: java-spel-injection
    patterns:
      - pattern-either:
          - pattern: $PARSER.parseExpression($EXPR)
          - pattern: new SpelExpressionParser().parseExpression(...)
          - patterns:
              - pattern: SpelExpressionParser.parseExpression($VAR)
              - pattern-not: SpelExpressionParser.parseExpression("...")
    message: "[Java] Critical: SpEL injection - potential RCE via expression language."
    languages: [java]
    severity: ERROR
    metadata:
      risk_score: 90
      category: code_injection