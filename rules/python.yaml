# ==========================================
# Python Threat Detection
# ==========================================

rules:
  # Regula 1-A: High risk subprocess (shell=True, os.system) -> High/CRITICAL
  - id: python-dangerous-subprocess-shell
    pattern-either:
      - pattern: subprocess.call(..., shell=True, ...)
      - pattern: subprocess.run(..., shell=True, ...)
      - pattern: subprocess.Popen(..., shell=True, ...)
      - pattern: os.system(...)
      - pattern: os.popen(...)
      # Catch obfuscated assignments
      - patterns:
          - pattern: $SUB.call(..., shell=True, ...)
          - pattern-inside: |
              $SUB = __import__('subprocess')
              ...
    message: "[Python] Warning: Script executes system commands with shell=True (High Risk)."
    languages: [python]
    severity: WARNING
    metadata:
      risk_score: 60
      category: indirect-execution

  # Regula 1-B: Low/Info risk subprocess (List argument, no shell=True) -> Low
  - id: python-subprocess-list-args
    patterns:
      - pattern-either:
          - pattern: subprocess.call([...], ...)
          - pattern: subprocess.run([...], ...)
          - pattern: subprocess.Popen([...], ...)
      - pattern-not: subprocess.call(..., shell=True, ...)
      - pattern-not: subprocess.run(..., shell=True, ...)
      - pattern-not: subprocess.Popen(..., shell=True, ...)
    message: "[Python] Info: Script executes external commands (List argument). Verify usage."
    languages: [python]
    severity: INFO
    metadata:
      risk_score: 10
      category: indirect-execution
  
  # Regula 1-C: Suspicious commands in subprocess list (High Risk)
  - id: python-suspicious-dropper-binary
    patterns:
      - pattern-either:
          - pattern: subprocess.run([$BIN, ...], ...)
          - pattern: subprocess.call([$BIN, ...], ...)
          - pattern: subprocess.Popen([$BIN, ...], ...)
      - metavariable-regex:
          metavariable: $BIN
          regex: "['\"](wget|curl|certutil|bitsadmin)['\"]"
    message: "[Python] Critical: Script attempts to download external files using '$BIN'. This is typical 'Dropper' behavior."
    languages: [python]
    severity: CRITICAL
    metadata:
      risk_score: 80
      category: malware-dropper
  
  # Regula 1-D: Suspicious shell binaries in subprocess list (Medium Risk)
  - id: python-suspicious-shell-binary
    patterns:
      - pattern-either:
          - pattern: subprocess.run([$BIN, ...], ...)
          - pattern: subprocess.call([$BIN, ...], ...)
          - pattern: subprocess.Popen([$BIN, ...], ...)
      - metavariable-regex:
          metavariable: $BIN
          regex: "['\"](bash|sh|zsh|dash|powershell|cmd)['\"]"
    message: "[Python] Warning: Script invokes a shell ('$BIN') inside Python. Check for hidden payloads."
    languages: [python]
    severity: WARNING
    metadata:
      risk_score: 60
      category: indirect-execution

  # Regula 2: Detect reverse shell patterns (Critical) -> Mark 100 points
  - id: python-reverse-shell
    pattern-either:
      - patterns:
          - pattern: |
              $SOCK = socket.socket(...)
              ...
              $SOCK.connect(...)
              ...
              subprocess.$METHOD(..., stdin=$SOCK.fileno(), ...)
      - patterns:
          - pattern: |
              $SOCK.connect(...)
              ...
              os.dup2($SOCK.fileno(), ...)
      - patterns:
          - pattern-inside: |
              import socket
              ...
          - pattern: |
              subprocess.call(['/bin/sh', ...], ...)
    message: "[Python] Critical: Potential reverse shell detected."
    languages: [python]
    severity: CRITICAL
    metadata:
      risk_score: 100
      category: backdoor

  # Regula 3: Detect obfuscated code execution (High risk) -> Mark 80 points
  - id: python-obfuscated-code
    pattern-either:
      - pattern: eval(base64.b64decode(...))
      - pattern: exec(base64.b64decode(...))
      - pattern: eval(compile(..., '<string>', 'exec'))
      - pattern: exec(marshal.loads(...))
      - pattern: eval($STR.decode(...))
      - pattern: exec(__import__('zlib').decompress(...))
      - patterns:
          - pattern: eval(...)
          - pattern-inside: |
              import base64
              ...
      - patterns:
          - pattern: exec(...)
          - pattern-inside: |
              import marshal
              ...
    message: "[Python] High: Obfuscated code execution detected."
    languages: [python]
    severity: WARNING
    metadata:
      risk_score: 80
      category: obfuscation

  # Regula 5: Detect sensitive file operations (Medium risk) -> Mark 30 points
  - id: python-sensitive-file-ops
    patterns:
      - pattern-either:
          - pattern: open($PATH, "w")
          - pattern: open($PATH, "wb")
          - pattern: open($PATH, "a")
      - metavariable-regex:
          metavariable: $PATH
          regex: ".*((/etc/|/bin/|/boot/|/usr/bin/|\\.ssh/|/root/|cron|passwd|shadow).*|.*\\.so$|.*\\.dll$)"
    message: "[Python] Warning: Script attempts to write to sensitive system locations."
    languages: [python]
    severity: WARNING
    metadata:
      risk_score: 30
      category: file_manipulation

  # Regula 6: Detect network backdoor spawn (Critical) -> Mark 90 points
  - id: python-spawn-shell-in-socket
    patterns:
      - pattern-inside: |
          import socket
          ...
      - pattern-either:
          - pattern: subprocess.call(['/bin/sh', ...], ...)
          - pattern: subprocess.call(['/bin/bash', ...], ...)
          - pattern: subprocess.Popen(['/bin/sh', ...], ...)
          - pattern: subprocess.Popen(['/bin/bash', ...], ...)
          - pattern: os.system('/bin/sh')
          - pattern: os.system('/bin/bash')
    message: "[Python] Critical: Shell spawned in socket context - likely reverse shell."
    languages: [python]
    severity: CRITICAL
    metadata:
      risk_score: 90
      category: backdoor

  # Regula 8: Detect dynamic code loading (Medium risk) -> Mark 20 points
  - id: python-dynamic-import
    pattern-either:
      - pattern: __import__($STR)
      - pattern: importlib.import_module($STR)
      - pattern: exec("import ...")
      - pattern: eval("import ...")
    message: "[Python] Warning: Dynamic code import detected."
    languages: [python]
    severity: WARNING
    metadata:
      risk_score: 20
      category: code_injection

  # Regula 9: Detect raw socket usage (Low-Medium risk) -> Mark 20 points
  - id: python-raw-socket
    patterns:
      - pattern: socket.socket(socket.AF_INET, socket.SOCK_RAW, ...)
    message: "[Python] Info: Raw socket usage detected - potential packet manipulation."
    languages: [python]
    severity: WARNING
    metadata:
      risk_score: 10
      category: network

  # # Regula 10: Detect VulnWatchDog Malware (Critical) -> Mark 100 points
  # - id: python-malware-vulnwatchdog
  #   pattern-either:
  #     # Specific logic for building the GPT prompt with parsed search results
  #     - patterns:
  #         - pattern: |
  #             def build_prompt(cve_info: Dict, search_results: List[Dict], poc_results_str: str) -> str:
  #                 ...
  #     # Specific logic for searching GitHub to download PoCs automatically
  #     - pattern: |
  #         $QUERY = f"{query}+(poc+OR+exploit)+NOT+test"
  #     # Specific internal function call combination for the payload
  #     - pattern: |
  #         queue_gpt_retry($ID, $PROMPT)
  #   message: "[Python] Critical: VulnWatchDog malware detected. This tool pretends to be a scanner but facilitates the download of malicious CVE PoCs (backdoors) to the local machine."
  #   languages: [python]
  #   severity: CRITICAL
  #   metadata:
  #     risk_score: 100
  #     category: malware