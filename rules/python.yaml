# ==========================================
# Python Threat Detection
# ==========================================

rules:
  # Regula 1: Detect dangerous subprocess execution (Medium risk) -> Mark 30 points
  - id: python-dangerous-subprocess
    pattern-either:
      - pattern: subprocess.call(...)
      - pattern: subprocess.run(...)
      - pattern: subprocess.Popen(...)
      - pattern: os.system(...)
      - pattern: os.popen(...)
      - patterns:
          - pattern: $SUB.call(...)
          - pattern-inside: |
              $SUB = __import__('subprocess')
              ...
      - patterns:
          - pattern: $SUB.run(...)
          - pattern-inside: |
              $SUB = __import__('subprocess')
              ...
    message: "[Python] Warning: Script executes system commands."
    languages: [python]
    severity: WARNING
    metadata:
      risk_score: 30
      category: rce

  # Regula 2: Detect reverse shell patterns (Critical) -> Mark 100 points
  - id: python-reverse-shell
    pattern-either:
      - patterns:
          - pattern: |
              $SOCK = socket.socket(...)
              ...
              $SOCK.connect(...)
              ...
              subprocess.$METHOD(..., stdin=$SOCK.fileno(), ...)
      - patterns:
          - pattern: |
              $SOCK.connect(...)
              ...
              os.dup2($SOCK.fileno(), ...)
      - patterns:
          - pattern-inside: |
              import socket
              ...
          - pattern: |
              subprocess.call(['/bin/sh', ...], ...)
    message: "[Python] Critical: Potential reverse shell detected."
    languages: [python]
    severity: ERROR
    metadata:
      risk_score: 100
      category: backdoor

  # Regula 3: Detect obfuscated code execution (High risk) -> Mark 80 points
  - id: python-obfuscated-code
    pattern-either:
      - pattern: eval(base64.b64decode(...))
      - pattern: exec(base64.b64decode(...))
      - pattern: eval(compile(..., '<string>', 'exec'))
      - pattern: exec(marshal.loads(...))
      - pattern: eval($STR.decode(...))
      - pattern: exec(__import__('zlib').decompress(...))
      - patterns:
          - pattern: eval(...)
          - pattern-inside: |
              import base64
              ...
      - patterns:
          - pattern: exec(...)
          - pattern-inside: |
              import marshal
              ...
    message: "[Python] High: Obfuscated code execution detected."
    languages: [python]
    severity: WARNING
    metadata:
      risk_score: 80
      category: obfuscation

  # Regula 4: Detect dangerous deserialization (High risk) -> Mark 70 points
  - id: python-unsafe-deserialization
    pattern-either:
      - pattern: pickle.loads(...)
      - pattern: pickle.load($FILE)
      - pattern: yaml.load(..., Loader=yaml.Loader)
      - pattern: eval(...)
      - pattern: exec(...)
    message: "[Python] High: Unsafe deserialization or code execution detected."
    languages: [python]
    severity: ERROR
    metadata:
      risk_score: 70
      category: deserialization

  # Regula 5: Detect sensitive file operations (Medium risk) -> Mark 30 points
  - id: python-sensitive-file-ops
    patterns:
      - pattern-either:
          - pattern: open($PATH, "w")
          - pattern: open($PATH, "wb")
          - pattern: open($PATH, "a")
      - metavariable-regex:
          metavariable: $PATH
          regex: ".*((/etc/|/bin/|/boot/|/usr/bin/|\\.ssh/|/root/|cron|passwd|shadow).*|.*\\.so$|.*\\.dll$)"
    message: "[Python] Warning: Script attempts to write to sensitive system locations."
    languages: [python]
    severity: WARNING
    metadata:
      risk_score: 30
      category: file_manipulation

  # Regula 6: Detect network backdoor spawn (Critical) -> Mark 90 points
  - id: python-spawn-shell-in-socket
    patterns:
      - pattern-inside: |
          import socket
          ...
      - pattern-either:
          - pattern: subprocess.call(['/bin/sh', ...], ...)
          - pattern: subprocess.call(['/bin/bash', ...], ...)
          - pattern: subprocess.Popen(['/bin/sh', ...], ...)
          - pattern: subprocess.Popen(['/bin/bash', ...], ...)
          - pattern: os.system('/bin/sh')
          - pattern: os.system('/bin/bash')
    message: "[Python] Critical: Shell spawned in socket context - likely reverse shell."
    languages: [python]
    severity: ERROR
    metadata:
      risk_score: 90
      category: backdoor

  # Regula 7: Detect hardcoded credentials (Medium risk) -> Mark 30 points
  - id: python-hardcoded-credentials
    pattern-either:
      - patterns:
          - pattern: $VAR = "..."
          - metavariable-regex:
              metavariable: $VAR
              regex: ".*(password|passwd|pwd|secret|token|api_key|apikey|access_key).*"
      - pattern: |
          $DICT = {..., "password": "...", ...}
      - pattern: |
          $DICT = {..., "token": "...", ...}
      - pattern: |
          $DICT = {..., "api_key": "...", ...}
    message: "[Python] Warning: Potential hardcoded credentials detected."
    languages: [python]
    severity: WARNING
    metadata:
      risk_score: 30
      category: credential_leak

  # Regula 8: Detect dynamic code loading (Medium risk) -> Mark 20 points
  - id: python-dynamic-import
    pattern-either:
      - pattern: __import__($STR)
      - pattern: importlib.import_module($STR)
      - pattern: exec("import ...")
      - pattern: eval("import ...")
    message: "[Python] Warning: Dynamic code import detected."
    languages: [python]
    severity: WARNING
    metadata:
      risk_score: 20
      category: code_injection

  # Regula 9: Detect raw socket usage (Low-Medium risk) -> Mark 20 points
  - id: python-raw-socket
    patterns:
      - pattern: socket.socket(socket.AF_INET, socket.SOCK_RAW, ...)
    message: "[Python] Info: Raw socket usage detected - potential packet manipulation."
    languages: [python]
    severity: WARNING
    metadata:
      risk_score: 10
      category: network