# ==========================================
# Go Threat Detection Rules
# ==========================================

rules:
  # Regula 1: Detect direct system command execution (Medium risk) -> Mark 50 points
  - id: go-dangerous-exec
    pattern-either:
      - pattern: exec.Command(...)
      - pattern: exec.CommandContext(..., ...)
      - pattern: syscall.Exec(...)
      - pattern: syscall.ForkExec(...)
      - pattern: syscall.StartProcess(...)
    message: "[Go] Warning: Direct system command execution detected."
    languages: [go]
    severity: WARNING
    metadata:
      risk_score: 30
      category: rce

  # Regula 2: Detect command execution with shell (High risk) -> Mark 70 points
  - id: go-shell-execution
    patterns:
      - pattern-either:
          - pattern: exec.Command("sh", "-c", ...)
          - pattern: exec.Command("bash", "-c", ...)
          - pattern: exec.Command("/bin/sh", "-c", ...)
          - pattern: exec.Command("/bin/bash", "-c", ...)
          - pattern: exec.Command("cmd", "/c", ...)
          - pattern: exec.Command("powershell", ...)
    message: "[Go] High: Shell execution with potential command injection risk."
    languages: [go]
    severity: ERROR
    metadata:
      risk_score: 70
      category: rce

  # Regula 3: Detect reverse shell patterns (Critical) -> Mark 100 points
  - id: go-reverse-shell-pattern
    patterns:
      - pattern-either:
          - pattern: |
              $CMD = exec.Command(...)
              ...
              $CMD.Stdin = $CONN
              ...
              $CMD.Stdout = $CONN
              ...
              $CMD.Stderr = $CONN
          - pattern: |
              $CMD.Stdin = $CONN
              $CMD.Stdout = $CONN
              $CMD.Stderr = $CONN
    message: "[Go] Critical: Reverse Shell detected (Network piped to Command)."
    languages: [go]
    severity: ERROR
    metadata:
      risk_score: 100
      category: backdoor

  # Regula 4: Detect hardcoded reverse shell commands (Critical) -> Mark 95 points
  - id: go-reverse-shell-hardcoded
    pattern-either:
      - patterns:
          - pattern-regex: "exec.Command\\(.*\\/bin\\/(sh|bash).*\\>\\&.*\\/dev\\/tcp\\/.*"
      - patterns:
          - pattern: exec.Command($SHELL, "-c", $CMD)
          - metavariable-regex:
              metavariable: $CMD
              regex: ".*(>/dev/tcp/|nc |netcat |socat |telnet ).*"
    message: "[Go] Critical: Hardcoded Reverse Shell command detected."
    languages: [go]
    severity: ERROR
    metadata:
      risk_score: 95
      category: backdoor

  # Regula 5: Detect file dropper patterns (High risk) -> Mark 75 points
  - id: go-file-dropper
    patterns:
      - pattern: |
          $RESP, $ERR := http.Get(...)
          ...
          $OUT, $ERR := os.Create(...)
          ...
          io.Copy($OUT, $RESP.Body)
    message: "[Go] High: File Dropper pattern (Download + Write) detected."
    languages: [go]
    severity: ERROR
    metadata:
      risk_score: 75
      category: file_manipulation

  # Regula 6: Detect network connections (Low-Medium risk) -> Mark 35 points
  - id: go-network-connection
    pattern-either:
      - pattern: net.Dial("tcp", ...)
      - pattern: net.DialTCP(...)
      - pattern: net.DialTimeout("tcp", ...)
      - pattern: tls.Dial("tcp", ...)
    message: "[Go] Info: Network TCP connection detected."
    languages: [go]
    severity: INFO
    metadata:
      risk_score: 10
      category: network

  # Regula 7: Detect unsafe deserialization (High risk) -> Mark 70 points
  - id: go-unsafe-deserialization
    pattern-either:
      - pattern: gob.NewDecoder($VAR).Decode(...)
      - pattern: json.Unmarshal($INPUT, ...)
      - pattern: yaml.Unmarshal($INPUT, ...)
      - pattern: xml.Unmarshal($INPUT, ...)
    message: "[Go] Warning: Deserialization of untrusted data - potential code execution."
    languages: [go]
    severity: WARNING
    metadata:
      risk_score: 70
      category: deserialization

  # Regula 8: Detect unsafe pointer operations (Medium risk) -> Mark 45 points
  - id: go-unsafe-operations
    pattern-either:
      - pattern: unsafe.Pointer(...)
      - pattern: (*$TYPE)(unsafe.Pointer(...))
      - pattern: reflect.SliceHeader{...}
      - pattern: reflect.StringHeader{...}
    message: "[Go] Warning: Unsafe memory operations (potential shellcode/memory corruption)."
    languages: [go]
    severity: WARNING
    metadata:
      risk_score: 45
      category: memory_corruption

  # Regula 9: Detect CGO dangerous usage (Medium-High risk) -> Mark 60 points
  - id: go-cgo-dangerous
    pattern-either:
      - pattern: C.system(...)
      - pattern: C.exec(...)
      - pattern: C.popen(...)
      - pattern: C.malloc(...)
      - pattern: C.free(...)
    message: "[Go] Warning: Dangerous CGO C function calls detected."
    languages: [go]
    severity: WARNING
    metadata:
      risk_score: 60
      category: rce

  # Regula 10: Detect file operations in sensitive paths (Medium risk) -> Mark 50 points
  - id: go-sensitive-file-ops
    patterns:
      - pattern-either:
          - pattern: os.Create($PATH)
          - pattern: os.OpenFile($PATH, ..., ...)
          - pattern: ioutil.WriteFile($PATH, ...)
          - pattern: os.WriteFile($PATH, ...)
      - metavariable-regex:
          metavariable: $PATH
          regex: ".*((/etc/|/bin/|/sbin/|/usr/bin/|\\.ssh/|/root/|cron|passwd|shadow).*)"
    message: "[Go] Warning: File operation in sensitive system location."
    languages: [go]
    severity: WARNING
    metadata:
      risk_score: 50
      category: file_manipulation

  # Regula 11: Detect eval-like patterns via plugin (High risk) -> Mark 80 points
  - id: go-plugin-loading
    pattern-either:
      - pattern: plugin.Open(...)
      - patterns:
          - pattern: plugin.Open($PATH)
          - pattern-not: plugin.Open("...")
    message: "[Go] High: Dynamic plugin loading - potential arbitrary code execution."
    languages: [go]
    severity: ERROR
    metadata:
      risk_score: 80
      category: code_injection

  # Regula 12: Detect crypto backdoors (Medium risk) -> Mark 55 points
  - id: go-weak-crypto
    pattern-either:
      - pattern: md5.New()
      - pattern: sha1.New()
      - pattern: des.NewCipher(...)
      - pattern: rc4.NewCipher(...)
      - pattern: rand.Read(...)
    message: "[Go] Warning: Weak/insecure cryptographic function usage."
    languages: [go]
    severity: WARNING
    metadata:
      risk_score: 55
      category: weak_crypto

  # Regula 13: Detect hardcoded credentials (Medium risk) -> Mark 30 points
  - id: go-hardcoded-credentials
    patterns:
      - pattern-either:
          - pattern: |
              $VAR := "$VALUE"
          - pattern: |
              const $VAR = "$VALUE"
      - metavariable-regex:
          metavariable: $VAR
          regex: ".*(password|passwd|pwd|secret|token|apikey|api_key|accesskey).*"
    message: "[Go] Warning: Potential hardcoded credentials detected."
    languages: [go]
    severity: WARNING
    metadata:
      risk_score: 30
      category: credential_leak

  # Regula 14: Detect SQL injection risks (Medium risk) -> Mark 40 points
  - id: go-sql-injection
    patterns:
      - pattern-either:
          - pattern: |
              $DB.Query($SQL + ...)
          - pattern: |
              $DB.Exec($SQL + ...)
          - pattern: |
              $DB.Query(fmt.Sprintf(...))
          - pattern: |
              $DB.Exec(fmt.Sprintf(...))
    message: "[Go] Warning: Potential SQL injection - use parameterized queries."
    languages: [go]
    severity: WARNING
    metadata:
      risk_score: 40
      category: sql_injection